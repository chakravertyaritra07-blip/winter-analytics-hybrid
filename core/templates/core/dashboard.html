<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnalyticsOS | Ultimate Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-body: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-primary: #0f172a; --text-secondary: #64748b; --brand: #1e293b; --accent: #3b82f6; --success: #10b981; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); font-size: 0.95rem; -webkit-font-smoothing: antialiased; }
        .navbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.75rem 0; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .navbar-brand { font-weight: 700; font-size: 1.1rem; color: var(--brand); letter-spacing: -0.5px; }
        .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; transition: border-color 0.2s; }
        .panel:hover { border-color: #cbd5e1; }
        .upload-zone { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 8px; padding: 40px; text-align: center; transition: all 0.2s; cursor: pointer; }
        .upload-zone:hover { background: #eff6ff; border-color: var(--accent); }
        .table-custom th { font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 600; }
        .shock-badge { background: #fef2f2; color: #991b1b; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; border: 1px solid #fecaca; }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="fw-bold text-dark">Initializing Model Arena...</h5>
        <p class="text-secondary small text-center mb-0">Running XGBoost, Neural Nets, and ARIMA...</p>
    </div>

    <nav class="navbar sticky-top">
        <div class="container">
            <div class="d-flex align-items-center gap-3">
                <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                    <i class="bi bi-stack text-primary"></i>
                    AnalyticsOS <span class="badge bg-dark ms-2 fw-normal" style="font-size: 0.7em;">ULTIMATE</span>
                </a>
                <div class="vr mx-2 text-secondary opacity-25"></div>
                <div class="d-flex align-items-center text-secondary small fw-medium">
                    <span class="badge bg-success bg-opacity-10 text-success border border-success me-2">LIVE</span>
                    DSGE Hybrid Engine
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-white border text-secondary" onclick="window.location.href='/'">
                    <i class="bi bi-plus-lg me-1"></i> New Analysis
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="row mb-4 align-items-end">
            <div class="col-md-8">
                <h2 class="fw-bold text-dark mb-1">Macro-Economic Intelligence</h2>
                <p class="text-secondary mb-0">Multivariate benchmarking. Supports PWT, ILOSTAT, and Sectoral Indices.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="badge bg-white text-secondary border fw-normal">{% now "Y-m-d H:i" %} UTC</span>
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger shadow-sm border-0 mb-4">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Pipeline Error:</strong> {{ error }}
        </div>
        {% endif %}

        {% if not step %}
        <div class="panel">
            <div class="panel-header">
                <h5 class="panel-title">1. Data Ingestion</h5>
                <span class="badge bg-light text-dark border"><i class="bi bi-file-earmark-spreadsheet"></i> Smart Scan</span>
            </div>
            <form method="post" enctype="multipart/form-data" onsubmit="document.getElementById('loading').style.display='flex'">
                {% csrf_token %}
                <div class="upload-zone position-relative">
                    <input type="file" name="dataset" required class="position-absolute top-0 start-0 w-100 h-100 opacity-0">
                    <div class="py-2">
                        <i class="bi bi-cloud-arrow-up fs-1 text-secondary mb-3 d-block opacity-50"></i>
                        <h6 class="fw-bold text-dark mb-1">Drop Economic Data Here</h6>
                        <div class="small text-secondary">Supports .xlsx (Penn World Table), .pdf, or .csv.<br><em>Engine will auto-detect Countries, Sectors, and Productivity Metrics.</em></div>
                    </div>
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold shadow-sm"><i class="bi bi-search me-2"></i>Scan Dataset</button>
                </div>
            </form>
        </div>
        {% endif %}

        {% if step == 'configure' %}
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="panel border-primary border-opacity-25">
                    <div class="text-center mb-4">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle mx-auto d-flex align-items-center justify-content-center mb-3" style="width: 50px; height: 50px;"><i class="bi bi-sliders fs-4"></i></div>
                        <h4 class="fw-bold">Configure Analysis Parameters</h4>
                    </div>
                    <form method="post" onsubmit="document.getElementById('loading').style.display='flex'">
                        {% csrf_token %}
                        <input type="hidden" name="filename" value="{{ filename }}">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary small">Jurisdiction</label>
                                <select name="country" class="form-select form-select-lg fw-semibold">
                                    {% for c in countries %}<option value="{{ c }}" {% if c == 'India' %}selected{% endif %}>{{ c }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary small">Target Variable</label>
                                <select name="target_var" class="form-select form-select-lg">
                                    {% for v in variables %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary small">Sector (Optional)</label>
                                <select name="sector_col" class="form-select form-select-lg">
                                    <option value="">-- None (Aggregate) --</option>
                                    {% for s in sector_cols %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-dark w-100 py-3 fw-bold mt-4 shadow-sm">Run Model Arena (All Tiers) <i class="bi bi-lightning-charge-fill ms-2"></i></button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        {% if step == 'results' %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-0">Analysis Report: {{ target_var }}</h2>
                <div class="text-secondary">Region: {{ selected_country }}</div>
            </div>
            <div class="text-end">
                <span class="d-block text-secondary small fw-bold uppercase">Champion Model</span>
                <span class="badge bg-success fs-6">{{ champion }} (MAPE: {{ champion_score }}%)</span>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="panel h-100 p-0 overflow-hidden">
                    <div class="p-3 border-bottom bg-light"><h6 class="fw-bold m-0"><i class="bi bi-trophy-fill text-warning me-2"></i>Model Leaderboard</h6></div>
                    <table class="table table-hover mb-0 table-custom align-middle">
                        <thead class="table-light"><tr><th>Model Tier</th><th class="text-end">MAPE Error</th></tr></thead>
                        <tbody>
                            {% for name, score in results.items %}
                            <tr><td class="fw-medium">{{ name }}</td><td class="text-end fw-bold {% if forloop.first %}text-success{% endif %}">{{ score }}%</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-8">
                <div class="panel h-100 p-0 overflow-hidden">
                    <div class="p-3 border-bottom bg-light"><h6 class="fw-bold m-0">Forecast Visualization (The Battle)</h6></div>
                    <div class="p-3"><img src="data:image/png;base64,{{ battle_plot }}" class="img-fluid w-100 rounded"></div>
                </div>
            </div>
        </div>

        {% if sector_leaderboard %}
        <div class="panel mt-4">
            <div class="d-flex align-items-center mb-3">
                <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;"><i class="bi bi-bar-chart-fill fs-5"></i></div>
                <div>
                    <h6 class="fw-bold m-0 text-dark">Sector Resilience & Growth Leaderboard</h6>
                    <small class="text-secondary">Ranking based on Average Annual Growth (Strength) vs. Volatility (Risk).</small>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle small mb-0 table-hover">
                    <thead class="table-light text-secondary">
                        <tr><th>Rank</th><th>Sector / Entity</th><th>Avg Growth</th><th>Volatility (Risk)</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        {% for s in sector_leaderboard|slice:":5" %} 
                        <tr>
                            <td class="fw-bold text-muted">#{{ forloop.counter }}</td>
                            <td class="fw-bold text-dark">{{ s.sector }}</td>
                            <td class="text-success fw-bold">+{{ s.avg_growth }}%</td>
                            <td class="text-secondary">{{ s.volatility }}%</td>
                            <td>
                                {% if s.volatility < 5 %}<span class="badge bg-success bg-opacity-10 text-success border border-success">Stable Giant</span>
                                {% elif s.avg_growth > 10 %}<span class="badge bg-warning bg-opacity-10 text-warning border border-warning">High Growth</span>
                                {% else %}<span class="badge bg-light text-dark border">Cyclical</span>{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div class="row g-4 mt-1">
            <div class="col-md-6">
                <div class="panel h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0">5-Year Projection</h6>
                        <select id="modelSelector" class="form-select form-select-sm w-auto border-primary text-primary fw-bold" onchange="updateForecast()">
                            </select>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light"><tr><th>Year</th><th>Predicted Value</th></tr></thead>
                            <tbody id="forecastTableBody"></tbody>
                        </table>
                    </div>
                    
                    <h6 class="fw-bold mt-4 mb-2 small text-uppercase text-secondary">DSGE Shock Analysis</h6>
                    {% if shocks %}
                        <div class="d-flex flex-wrap gap-2">
                        {% for s in shocks %}
                            <span class="badge shock-badge" title="{{ s.reason }}">{{ s.year }}: {{ s.growth }}% ({{ s.resilience }})</span>
                        {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-muted small">No structural shocks detected (>1.5 SD).</div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-6">
                <div class="panel h-100 p-0 overflow-hidden">
                    <div class="p-3 border-bottom bg-light"><h6 class="fw-bold m-0 small text-center">Data Distribution</h6></div>
                    <div class="p-3"><img src="data:image/png;base64,{{ hist_plot }}" class="img-fluid w-100 rounded"></div>
                </div>
            </div>
        </div>

        {% if yoy_data %}
        <div class="panel mt-4 p-0 overflow-hidden">
            <div class="p-3 border-bottom bg-light"><h6 class="fw-bold m-0 text-dark"><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Annual Growth Analysis (Last 5 Years)</h6></div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light text-secondary text-uppercase small fw-bold">
                        <tr><th class="ps-4 py-3">Year</th><th class="py-3">Value</th><th class="py-3">Growth %</th><th class="pe-4 py-3">Status</th></tr>
                    </thead>
                    <tbody>
                        {% for row in yoy_data reversed %}
                        <tr>
                            <td class="ps-4 fw-bold text-dark">
                                {% firstof row.year row.time row.Date row.Year as year_val %}{{ year_val|floatformat:0 }}
                            </td>
                            <td class="font-monospace text-secondary">{{ row.target_var|floatformat:2 }}</td>
                            <td class="fw-bold">
                                {% if row.YoY_Growth > 0 %}<span class="text-success"><i class="bi bi-caret-up-fill"></i> {{ row.YoY_Growth|floatformat:2 }}%</span>
                                {% else %}<span class="text-danger"><i class="bi bi-caret-down-fill"></i> {{ row.YoY_Growth|floatformat:2 }}%</span>{% endif %}
                            </td>
                            <td class="pe-4">
                                {% if row.YoY_Growth < -1.0 %}<span class="badge bg-danger bg-opacity-10 text-danger border border-danger">Shock</span>
                                {% elif row.YoY_Growth > 5.0 %}<span class="badge bg-success bg-opacity-10 text-success border border-success">Boom</span>
                                {% else %}<span class="badge bg-light text-secondary border">Stable</span>{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
            
        {% if pie_plot %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="panel text-center">
                    <h6 class="fw-bold mb-3">Sector Breakdown</h6>
                    <img src="data:image/png;base64,{{ pie_plot }}" class="img-fluid rounded" style="max-height: 400px;">
                </div>
            </div>
        </div>
        {% endif %}

        <div class="mt-4 p-4 bg-white border rounded border-start border-4 border-warning shadow-sm">
            <h6 class="fw-bold small text-uppercase text-dark mb-1">Policy Implication</h6>
            <p class="small text-muted mb-0">Current trajectory suggests a return to steady-state growth. If structural shocks persist (check "DSGE Shock Analysis" panel), counter-cyclical fiscal intervention is recommended.</p>
        </div>

        <script>
            // Safely parse JSON from View (Fixed: Using JSON strings, no direct python list injection)
            const futureYears = JSON.parse('{{ future_years_json|safe }}');
            const allForecasts = JSON.parse('{{ all_forecasts_json|safe }}');
            const champion = "{{ champion }}";

            // Populate Dropdown
            const selector = document.getElementById('modelSelector');
            if (selector) {
                Object.keys(allForecasts).forEach(key => {
                    const option = document.createElement("option");
                    option.value = key;
                    option.text = key;
                    if (key === champion) option.selected = true;
                    selector.appendChild(option);
                });
            }

            function updateForecast() {
                if (!selector) return;
                
                const selectedModel = selector.value;
                const data = allForecasts[selectedModel];
                const tbody = document.getElementById('forecastTableBody');
                
                tbody.innerHTML = ''; 
                
                if (data && data.length === futureYears.length) {
                    for (let i = 0; i < futureYears.length; i++) {
                        let val = Number(data[i]);
                        const row = `<tr>
                            <td class="fw-bold">${futureYears[i]}</td>
                            <td class="font-monospace text-primary">${val.toFixed(2)}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-danger">Data unavailable for this model</td></tr>';
                }
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', updateForecast);
        </script>

        {% endif %}

    </div>

    <footer class="text-center py-5 mt-5 border-top bg-white">
        <div class="container text-muted small">
            <p class="mb-1 fw-semibold">AnalyticsOS v3.0 | Winter Analytics Team</p>
            <p class="opacity-75">Powered by Django 5.0 (Python) & R 4.5.2 (Econometrics)</p>
        </div>
    </footer>

</body>
</html>